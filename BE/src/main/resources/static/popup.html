<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Twilio ìˆ˜ì‹  í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/@twilio/voice-sdk@2.11.2/dist/twilio.min.js"></script>
    <style>
        .log-line {
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            margin-bottom: 8px;
            padding: 4px;
            border-bottom: 1px solid #eee;
        }
        #log-area {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
        }
        #session-info {
            margin: 10px 0;
            font-weight: bold;
            color: #333;
        }
        .final-summary {
            margin-top: 10px;
            padding: 10px;
            border-top: 2px solid #aaa;
            background: #f5f5f5;
            white-space: pre-line;
        }
        .summary-buttons {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .summary-buttons button {
            padding: 10px 20px;
            font-weight: bold;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }
        .summary-buttons button:hover {
            background-color: #0056b3;
        }
        #summary-content {
            border: 1px solid #ccc;
            padding: 15px;
            background-color: #fff;
            min-height: 100px;
            white-space: pre-line;
        }
    </style>
</head>
<body>
<h2>ğŸ“ ë¸Œë¼ìš°ì € ì „í™” ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...</h2>
<button id="update-session-btn" style="display:none;">ì„¸ì…˜ userId ë³€ê²½</button>
<button id="accept-btn" style="display:none;">ğŸ“ ì „í™” ìˆ˜ë½</button>

<div id="session-info">ğŸ”’ ì„¸ì…˜ ì •ë³´ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...</div>

<h3>ğŸ“ ì‹¤ì‹œê°„ STT ë¡œê·¸</h3>
<div id="log-area"></div>


<h3>ğŸ“œ ìµœì¢… ì „ì²´ í…ìŠ¤íŠ¸</h3>
<div id="final-inbound"></div>
<div id="final-outbound"></div>

<h3>ğŸ“ ìƒë‹´ ìš”ì•½</h3>
<div id="summary-section">
    <div class="summary-buttons">
        <button id="v1-summary-btn">v1 ìš”ì•½ ìƒì„±</button>
        <button id="v2-summary-btn">v2 ìš”ì•½ ìƒì„±</button>
    </div>
    <div id="summary-content">ìš”ì•½ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<script>
    let pendingConnection = null;
    let ws = null;
    let currentUserId = null;
    let callSessionId = null;

    const sessionInfoDiv = document.getElementById("session-info");
    const logArea = document.getElementById("log-area");
    const finalInboundDiv = document.getElementById("final-inbound");
    const finalOutboundDiv = document.getElementById("final-outbound");
    const summarySection = document.getElementById("summary-section");
    const summaryContentDiv = document.getElementById("summary-content");
    const v1SummaryBtn = document.getElementById("v1-summary-btn");
    const v2SummaryBtn = document.getElementById("v2-summary-btn");

    const lines = {}; // track + index í‚¤ ê¸°ë°˜ ì €ì¥
    const trackState = {
        INBOUND: { currentIndex: 0, finalReceived: false },
        OUTBOUND: { currentIndex: 0, finalReceived: false }
    };

    function parseQueryParams(queryString) {
        const params = {};
        if (!queryString) {
            return params;
        }
        queryString.split('&').forEach(pair => {
            const [key, value] = pair.split('=');
            if (key && value) {
                params[decodeURIComponent(key)] = decodeURIComponent(value);
            }
        });
        return params;
    }

    function setupWebSocketListeners(websocket) {
        websocket.onopen = () => {
            console.log("ğŸŒ WebSocket ì—°ê²° ì„±ê³µ, í†µí™” ìˆ˜ë½ ì§„í–‰");
            if (pendingConnection) {
                pendingConnection.accept();
                console.log("âœ… í†µí™” ìˆ˜ë½ ì™„ë£Œ");
                const parsed = parseQueryParams(pendingConnection.parameters.Params);
                const firstCallSid = parsed.initialCallSid;
                // í†µí™” ìˆ˜ë½ í›„ ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
                ws.send(JSON.stringify({
                    event: "callAccepted",
                    callSid: firstCallSid
                }));
                console.log("âœ…ìƒì„±ëœ ì›¹ì†Œì¼“ìœ¼ë¡œ í†µí™” ìˆ˜ë½ ì‹œ callSid ì „ì†¡ : ", firstCallSid);
                pendingConnection = null;
                document.getElementById("accept-btn").style.display = "none";
            }
        };
        websocket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);

                console.log("=== data ì¶œë ¥ ===");
                console.log("Received WebSocket data:", data);

                if (data.type === "sessionInfo") {
                    sessionInfoDiv.innerText = `ğŸ”‘ ì„¸ì…˜ ì½”ë“œ: ${data.sessionCode} | ìƒì„± ì‹œê°: ${data.createdAt} | í­ì–¸ íšŸìˆ˜: ${data.totalAbuseCnt}`;
                } else if (data.type === "totalAbuseCntUpdate") {
                    sessionInfoDiv.innerText = sessionInfoDiv.innerText.replace(/í­ì–¸ íšŸìˆ˜: .+/, `í­ì–¸ íšŸìˆ˜: ${data.totalAbuseCnt}`);
                    console.log(`ğŸ’¡ í­ì–¸ íšŸìˆ˜ ì—…ë°ì´íŠ¸ë¨: ${data.totalAbuseCnt} (ì„¸ì…˜ ID: ${data.callSessionId})`);
                } else if (data.type === "finalTranscript") {
                    const isInbound = data.track === "INBOUND";
                    const targetDiv = isInbound ? finalInboundDiv : finalOutboundDiv;
                    const label = isInbound ? "ğŸ‘¤ ê³ ê° ì „ì²´ í…ìŠ¤íŠ¸" : "ğŸ’¼ ìƒë‹´ì› ì „ì²´ í…ìŠ¤íŠ¸";

                    const summaryHTML = `
                    <div class="final-summary">
                        <strong>${label}</strong><br>
                        ${data.text}
                    </div>
                `;
                    targetDiv.innerHTML = summaryHTML;
                } else if (data.type === "stt") {
                    const sttLogData = data.payload;

                    const track = sttLogData.track;
                    const script = sttLogData.script || data.text;
                    const isFinal = sttLogData.isFinal;
                    const abuseLabel = isFinal ? (sttLogData.isAbuse ? `ğŸš« ${sttLogData.abuseType}` : "âœ… ì •ìƒ") : "ğŸŸ¡ ì¤‘ê°„";

                    const label = track === "INBOUND" ? "ğŸ‘¤ ê³ ê°" : "ğŸ’¼ ìƒë‹´ì›";
                    const finalLabel = isFinal ? "ğŸŸ¢ ìµœì¢…" : "ğŸŸ¡ ì¤‘ê°„";

                    const html = `<div class="log-line">${label} | ${finalLabel} | ${abuseLabel}<br>ğŸ—£ï¸ ${script}</div>`;

                    const state = trackState[track];
                    const key = `${track}-${state.currentIndex}`;

                    lines[key] = html;

                    if (isFinal) {
                        state.finalReceived = true;
                        state.currentIndex++;
                    }

                    logArea.innerHTML = Object.values(lines).join("");
                    logArea.scrollTop = logArea.scrollHeight;
                } else {

                    console.warn("Unknown WebSocket message type received:", data.type, data);
                }

            } catch (e) {
                console.error("âš ï¸ WebSocket ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:", e);
            }
        };
        websocket.onerror = err => console.error("âŒ WebSocket ì˜¤ë¥˜:", err);
        websocket.onclose = () => console.log("ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œ");
    }

    function showSummary(version) {
        tabV1.classList.remove('active');
        tabV2.classList.remove('active');

        if (!callSessionId) {
            summaryContentDiv.innerText = "ì„¸ì…˜ ì •ë³´ê°€ ì—†ì–´ ìš”ì•½ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }

        if (version === 'v1') {
            tabV1.classList.add('active');
            fetchSummary('simple');
        } else if (version === 'v2') {
            tabV2.classList.add('active');
            fetchSummary('detailed');
        }
    }

    function fetchSummary(summaryType) {
        // API ëª…ì„¸ì— ë§ëŠ” Path Variableê³¼ URL êµ¬ì„±
        const apiPath = `/api/call-sessions/${callSessionId}/summary/${summaryType}`;
        const jwtToken = localStorage.getItem('jwtToken');

        summaryContentDiv.innerText = "ğŸ“ ìš”ì•½ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";

        fetch(apiPath, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì²˜ë¦¬
                    throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.isSuccess) {
                    const summaryText = data.result.summaryText;
                    if (summaryText) {
                        summaryContentDiv.innerText = summaryText;
                    } else {
                        summaryContentDiv.innerText = "ìš”ì•½ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
                    }
                } else {
                    summaryContentDiv.innerText = `ğŸš¨ API ì˜¤ë¥˜: ${data.message}`;
                    console.error("ğŸš¨ API í˜¸ì¶œ ì‹¤íŒ¨:", data.message);
                }
            })
            .catch(error => {
                summaryContentDiv.innerText = `ğŸš¨ API í˜¸ì¶œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                console.error("ğŸš¨ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:", error);
            })
    }

    const jwtToken = localStorage.getItem('jwtToken'); // ë¸Œë¼ìš°ì € ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— jwtToken : <token> ì´ ì €ì¥ë˜ì–´ ìˆì–´ì•¼ í•¨
    if (!jwtToken) {
        console.error("ğŸš¨ JWT í† í°ì´ localStorageì— ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        sessionInfoDiv.innerText = "ğŸš¨ ë¡œê·¸ì¸ í•„ìš”: JWT í† í° ì—†ìŒ";
        // í† í°ì´ ì—†ìœ¼ë©´ Twilio Device ì´ˆê¸°í™” ì‹œë„ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    } else {
        fetch('/api/token', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        })
            .then(res => {
                if (!res.ok) {
                    console.error(`ğŸš¨ Twilio í† í° ìš”ì²­ ì‹¤íŒ¨: ${res.status} ${res.statusText}`);
                    sessionInfoDiv.innerText = `ğŸš¨ ì¸ì¦ ì‹¤íŒ¨: ${res.status} ${res.statusText}`;
                    throw new Error('Failed to get Twilio token');
                }
                return res.json();
            })
            .then(data => {
                const accessToken = data.result.twilioAccessToken;
                currentUserId = data.result.userId;

                if (!currentUserId) {
                    console.error("ğŸš¨ ì„œë²„ë¡œë¶€í„° userIdë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. WebSocket ì—°ê²° ë¶ˆê°€.");
                    sessionInfoDiv.innerText = "ğŸš¨ ì„œë²„ ì˜¤ë¥˜: ì‚¬ìš©ì ID ì—†ìŒ";
                    return;
                }

                const DeviceCtor = window.Device || (window.Twilio && Twilio.Device);
                if (!DeviceCtor) {
                    console.error("ğŸš¨ Twilio SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ/ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                    sessionInfoDiv.innerText = "ğŸš¨ Twilio SDK ë¡œë“œ ì‹¤íŒ¨";
                    return;
                }
                const device = new DeviceCtor(accessToken, { logLevel: 1 });

                device.on('registered', () => {
                    console.log('âœ… Device ready');
                    // Twilio.Device.audio.speakerDevices.set('default');
                    console.log('Twilio.Device.audio on registered:', (Twilio && Twilio.Device && Twilio.Device.audio) || device.audio);
                });

                device.on('incoming', conn => {
                    console.log('ğŸ“ ìˆ˜ì‹ :', conn.parameters.From);
                    pendingConnection = conn;
                    document.getElementById("accept-btn").style.display = "inline";
                    document.getElementById("update-session-btn").style.display = "inline";
                    // incoming í†µí™”ê°€ ìˆ˜ë½ë˜ê¸° ì „ì— ì·¨ì†Œë˜ì—ˆì„ ë•Œ ì²˜ë¦¬ í•„ìš”
                });

                device.register().catch(err => console.error('ğŸš¨ register() ì‹¤íŒ¨:', err));

                // Twilio Device ì´ˆê¸°í™” ì´í›„ ì„¸ì…˜ useId ë³€ê²½ì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                document.getElementById("update-session-btn").addEventListener("click", () => {
                    if (!pendingConnection) {
                        alert("ìˆ˜ì‹  ì „í™”ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    const parsedParams = parseQueryParams(pendingConnection.parameters.Params);
                    const initialCallSid = parsedParams.initialCallSid;
                    const callerNumber = pendingConnection.parameters.From;

                    fetch('/api/call-sessions/user', {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`
                        },
                        body: JSON.stringify({
                            originalInboundCallSid: initialCallSid,
                            callerNumber: callerNumber
                        })
                    })
                        .then(res => res.json())
                        .then(apiResponse => {
                            console.log("âœ… ì„¸ì…˜ ìƒì„± ì‘ë‹µ:", apiResponse);
                            if (apiResponse.isSuccess && apiResponse.result) {
                                const sessionInfo = apiResponse.result;

                                callSessionId = sessionInfo.callSessionId;
                                console.log("callsessionId : ", callSessionId);

                                // âœ… ì„¸ì…˜ ì •ë³´ UI ì—…ë°ì´íŠ¸
                                sessionInfoDiv.innerText = `ğŸ”‘ ì„¸ì…˜ ì½”ë“œ: ${sessionInfo.callSessionCode} | ìƒì„± ì‹œê°: ${sessionInfo.createdAt} | í­ì–¸ íšŸìˆ˜: ${sessionInfo.totalAbuseCnt}`;
                            } else {
                                console.error("ğŸš¨ ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨:", apiResponse.message || apiResponse);
                                alert("ì„¸ì…˜ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            }
                        })
                        .catch(err => console.error("ğŸš¨ ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜:", err));
                });

                document.getElementById("accept-btn").addEventListener("click", () => {
                    if (!pendingConnection) {
                        alert("í†µí™” ìˆ˜ë½ ëŒ€ê¸° ì¤‘ì¸ ì—°ê²°ì´ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    const parsedForSend = parseQueryParams(pendingConnection.parameters.Params);
                    const callSid = parsedForSend.initialCallSid;

                    // í†µí™” ìˆ˜ë½ í´ë¦­ ì‹œì—ë§Œ ì›¹ì†Œì¼“ ì—°ê²°ì„ ì‹œì‘í•˜ê³ , ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ìƒˆë¡œ ì—°ê²°í•˜ì§€ ì•ŠìŒ
                    if (!ws || ws.readyState === WebSocket.CLOSED) {
                        ws = new WebSocket(`wss://callprotect.site/ws/stt?userId=${currentUserId}`);

                        // ì›¹ì†Œì¼“ ì—°ê²° ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                        setupWebSocketListeners(ws);
                    } else {
                        // ì´ë¯¸ ì›¹ì†Œì¼“ ì—°ê²°ëœ ìƒíƒœë©´ ë°”ë¡œ í†µí™” ìˆ˜ë½
                        if (pendingConnection) {
                            pendingConnection.accept();
                            console.log("âœ… í†µí™” ìˆ˜ë½ ì™„ë£Œ (ì›¹ì†Œì¼“ ì´ë¯¸ ì—°ê²°ë¨)");

                            // í†µí™” ìˆ˜ë½ í›„ ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡
                            ws.send(JSON.stringify({
                                event: "callAccepted",
                                callSid: callSid
                            }));
                            console.log("âœ…ê¸°ì¡´ ì›¹ì†Œì¼“ìœ¼ë¡œ í†µí™” ìˆ˜ë½ ì‹œ callSid ì „ì†¡ : ", callSid);
                            pendingConnection = null;
                            document.getElementById("accept-btn").style.display = "none";
                        }
                    }
                });

                device.on('connect', () => console.log('ğŸ”Š í†µí™” ì—°ê²°ë¨'));
                device.on('disconnect', () => {
                    console.log('âŒ í†µí™” ì¢…ë£Œ');
                    document.getElementById("accept-btn").style.display = "none";
                });

                device.on('error', err => {
                    console.error('ğŸš¨ Twilio ì˜¤ë¥˜:', err);
                    document.getElementById("accept-btn").style.display = "none";
                });
            });
    }

    document.addEventListener("DOMContentLoaded", () => {
        v1SummaryBtn.addEventListener('click', () => {
            if (!callSessionId) {
                summaryContentDiv.innerText = "ğŸš¨ ì„¸ì…˜ ì •ë³´ê°€ ì—†ì–´ ìš”ì•½ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. [v1]";
                return;
            }
            fetchSummary('simple');
        });

        v2SummaryBtn.addEventListener('click', () => {
            if (!callSessionId) {
                summaryContentDiv.innerText = "ğŸš¨ ì„¸ì…˜ ì •ë³´ê°€ ì—†ì–´ ìš”ì•½ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.[v2]";
                return;
            }
            fetchSummary('detailed');
        });
    });

</script>
</body>
</html>