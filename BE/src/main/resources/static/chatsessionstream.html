<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<body>
<input type="number" id="sessionIdInput" placeholder="ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 200px; padding: 5px;">
<button id="analyze">ìƒë‹´ ìš”ì•½ ìš”ì²­</button>

<div id="response" style="margin-top:20px; white-space:pre-wrap;"></div>
<div id="typing-indicator" style="display: none;">ìš”ì•½ ì¤‘ì…ë‹ˆë‹¤<span id="dots"></span></div>

<script>
    document.getElementById("analyze").addEventListener("click", () => {
        const sessionId = document.getElementById("sessionIdInput").value;
        const responseDiv = document.getElementById("response");
        const typingIndicator = document.getElementById("typing-indicator");
        const dotsSpan = document.getElementById("dots");
        const token = localStorage.getItem("accessToken"); // âœ… í† í° ê°€ì ¸ì˜¤ê¸°

        responseDiv.innerHTML = "";
        typingIndicator.style.display = "block";

        let dotCount = 0;
        const dotInterval = setInterval(() => {
            dotCount = (dotCount + 1) % 4;
            dotsSpan.textContent = ".".repeat(dotCount);
        }, 500);

        const eventSource = new EventSource(`/api/chatbot/analyze/${sessionId}?token=${token}`); // âœ… token ì¶”ê°€

        let buffer = "";

        eventSource.onmessage = (event) => {
            const chunk = event.data;
            if (chunk === "[END]") {
                try {
                    const parsed = JSON.parse(buffer);
                    responseDiv.innerHTML = parsed.answer;
                } catch (e) {
                    console.error("JSON íŒŒì‹± ì˜¤ë¥˜", e);
                    responseDiv.innerHTML = "âŒ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨";
                }

                typingIndicator.style.display = "none";
                clearInterval(dotInterval);
                eventSource.close();
                return;
            }

            if (chunk.startsWith("[JSON]")) {
                buffer = chunk.replace("[JSON]", "").trim();
                console.log("ğŸ” JSON ìˆ˜ì‹ :", buffer);
            } else {
                responseDiv.innerHTML += chunk;
            }
        };

        eventSource.onerror = (err) => {
            console.error("â›” SSE ì˜¤ë¥˜", err);
            typingIndicator.style.display = "none";
            clearInterval(dotInterval);
            eventSource.close();
        };
    });
</script>

</body>
</html>
