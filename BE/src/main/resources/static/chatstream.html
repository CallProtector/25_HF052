<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>SSE Chat Stream</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.8; }
        #typing-indicator { font-weight: bold; display: none; margin-top: 10px; }
        #titleBox { margin-top: 6px; color: #555; }
    </style>
</head>
<body>
<h2>ì•…ì„± ë¯¼ì› ëŒ€ì‘ ì±—ë´‡</h2>

<div id="titleBox">ì œëª©: <span id="sessionTitle">ìƒˆ ëŒ€í™”</span></div> <!-- â˜… ì œëª© í‘œì‹œ -->

<input type="text" id="questionInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 400px; padding: 5px;">
<button id="start">ì§ˆë¬¸í•˜ê¸°</button>

<div id="response" style="margin-top:20px; white-space:pre-wrap; font-family:Arial; line-height:1.8;"></div>
<div id="typing-indicator">GPT is typing<span id="dots"></span></div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        let currentSessionId = null;

        document.getElementById("start").addEventListener("click", async () => {
            const question = document.getElementById("questionInput").value.trim();
            const responseDiv = document.getElementById("response");
            const typingIndicator = document.getElementById("typing-indicator");
            const dotsSpan = document.getElementById("dots");
            const sessionTitleEl = document.getElementById("sessionTitle");

            responseDiv.innerHTML = "";
            typingIndicator.style.display = "none";
            dotsSpan.textContent = "";

            if (!question) {
                alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }

            const token = localStorage.getItem("accessToken");
            if (!token) {
                alert("JWT í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € localStorageì— accessTokenì„ ì €ì¥í•˜ì„¸ìš”.");
                return;
            }

            // ì„¸ì…˜ ì—†ìœ¼ë©´ ìƒì„±
            if (!currentSessionId) {
                const sessionRes = await fetch("/api/chat-sessions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    }
                });

                if (!sessionRes.ok) {
                    alert("ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: " + sessionRes.status);
                    return;
                }

                const sessionData = await sessionRes.json();
                currentSessionId = sessionData.result.sessionId;
                // ì´ˆê¸° ì œëª© í‘œì‹œ (ë¹ˆ ê°’ì¼ ìˆ˜ ìˆìŒ)
                if (sessionData.result.title) {
                    sessionTitleEl.textContent = sessionData.result.title;
                }
                console.log("ì„¸ì…˜ ìƒì„± ì™„ë£Œ:", currentSessionId);
            }

            const encodedQuestion = encodeURIComponent(question);
            const esUrl = `/api/chat/stream?sessionId=${currentSessionId}&question=${encodedQuestion}&token=${token}`;
            const eventSource = new EventSource(esUrl);

            // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„°
            typingIndicator.style.display = "block";
            let dotCount = 0;
            const dotInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4;
                dotsSpan.textContent = ".".repeat(dotCount);
            }, 500);

            // ìŠ¤íŠ¸ë¦¼ ë³¸ë¬¸ ì²˜ë¦¬
            let buffer = "";

            // ê¸°ë³¸ message ì´ë²¤íŠ¸(ë‹µë³€ ì²­í¬)
            eventSource.onmessage = (event) => {
                const chunk = event.data;

                // ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ ì‹ í˜¸
                if (chunk === "[END]") {
                    try {
                        buffer = buffer.trim();
                        const jsonStart = buffer.indexOf("{");
                        const jsonEnd = buffer.lastIndexOf("}") + 1;
                        const jsonString = buffer.substring(jsonStart, jsonEnd).trim();

                        console.log("ğŸ“¦ ìµœì¢… íŒŒì‹± ëŒ€ìƒ JSON:", jsonString);

                        // ë‹«í˜ ì¤‘ë³µ/ë…¸ì´ì¦ˆ ë°©ì§€
                        const cleanedJson = jsonString.replace(/}\s*$/, "}");

                        const parsed = JSON.parse(cleanedJson);

                        // ì•ˆì „ ë Œë”ë§ (ê°„ë‹¨íˆ innerHTML ì‚¬ìš©í•˜ì§€ë§Œ ì‹ ë¢°ëœ ì„œë²„ë§Œ ì—°ê²°ëœ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ê¸°ì¤€)
                        responseDiv.innerHTML = `
                <p style="margin-bottom: 8px;"><strong>ğŸ’¬ ë‹µë³€:</strong><br>${parsed.answer}</p>
                <p style="margin-bottom: 4px;"><strong>ğŸ“š ì¶œì²˜:</strong></p>
                <ul style="margin: 0; padding: 0; list-style-type: none;">
                  ${parsed.sourcePages.map(sp => `
                    <li style="margin-bottom: 4px;">
                      <div style="display: flex; flex-direction: column; gap: 2px; align-items: flex-start;">
                        <span>ğŸ“Œ <strong>ìœ í˜•:</strong> ${sp["ìœ í˜•"]}</span>
                        <span>âš– <strong>ê´€ë ¨ ë²•ë¥ :</strong> ${sp["ê´€ë ¨ ë²•ë¥ "] || sp["ê´€ë ¨ë²•ë¥ "] || "ì—†ìŒ"}</span>
                      </div>
                    </li>
                  `).join("")}
                </ul>
              `;
                    } catch (e) {
                        console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", e);
                        responseDiv.textContent = "âš ï¸ ì‘ë‹µ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
                    } finally {
                        typingIndicator.style.display = "none";
                        clearInterval(dotInterval);
                        eventSource.close();
                    }
                    return;
                }

                // [JSON] ë¸”ë¡ë§Œ ëˆ„ì 
                if (chunk.startsWith("[JSON]")) {
                    buffer = chunk.replace("[JSON]", "").trim();
                    console.log("ğŸ” [JSON] ìˆ˜ì‹  ë°ì´í„°:", buffer);
                } else {
                    // ì‹¤ì‹œê°„ í† í°(ìš”ì•½/í”„ë¦¬ë·° ë“± í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ í™”ë©´ì— ë³´ì—¬ì¤˜ë„ ë¨)
                    console.log("ì‹¤ì‹œê°„ í† í°:", chunk);
                }
            };

            // â˜… íƒ€ì´í‹€ ì´ë²¤íŠ¸ ìˆ˜ì‹  â†’ ì¦‰ì‹œ UIì— ë°˜ì˜
            eventSource.addEventListener("title", (e) => {
                try {
                    const payload = JSON.parse(e.data); // { sessionId, title }
                    if (String(payload.sessionId) === String(currentSessionId) && payload.title) {
                        sessionTitleEl.textContent = payload.title;
                        console.log("ğŸ“ ì œëª© ê°±ì‹ :", payload.title);
                    }
                } catch (err) {
                    console.warn("title ì´ë²¤íŠ¸ íŒŒì‹± ì‹¤íŒ¨:", err);
                }
            });

            // ì—ëŸ¬/ì¢…ë£Œ ì²˜ë¦¬
            eventSource.onerror = () => {
                console.log("â›” SSE ì—°ê²° ì¢…ë£Œ/ì—ëŸ¬");
                typingIndicator.style.display = "none";
                clearInterval(dotInterval);
                eventSource.close();
            };
        });
    });
</script>
</body>
</html>
